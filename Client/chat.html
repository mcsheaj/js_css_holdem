<html>

<head>
    <title>Serverless Chat</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css">
    <script>
        //var apiBaseUrl = 'http://localhost:7071';
        var apiBaseUrl = 'https://func-jsholdem-useast.azurewebsites.net';
        var authProvider = 'aad'; // aad, twitter, microsoftaccount, google, facebook
    </script>
    <style type="text/css">
        .form-control {
            margin-bottom: 10px;
        }

        .quarter {
            width: 25%;
        }
    </style>
</head>

<body>
    <p>&nbsp;</p>
    <div id="container" class="container">
        <h3>Serverless chat</h3>
        <div class="row">
            <div class="signalr-demo col-sm">
                <hr />
                <form id="chat">
                    <input type="text" id="userName" class="form-control quarter"
                        placeholder="Type your user name..." />
                    <input type="text" id="messageText" class="form-control" placeholder="Type message here..." />
                </form>
            </div>
        </div>
    </div>
    <div id="messageTemplate" style="display:none;">
        <div class="row">
            <div class="col-sm">
                <hr />
                <div>
                    <div style="display: inline-block; padding-left: 12px;">
                        <div>
                            <a href="#" v-on:click.prevent="sendPrivateMessage(message.sender)">
                                <span class="text-info small"><strong>{{ message.sender }}</strong></span>
                            </a>
                        </div>
                        <div>
                            {{ message.text }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@aspnet/signalr@1.0.3/dist/browser/signalr.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@0.18.0/dist/axios.min.js"></script>

    <script>
        var app = {
            connection: null,
            ready: false,
            form: null,
            container: null,
            template: null,

            ///////////////////////////////////////////////
            // init members, connect to signalR and setup 
            // callback handlers
            ///////////////////////////////////////////////
            init: function () {
                // initialize some member variables
                app.form = document.getElementById("chat");
                app.container = document.getElementById("container");
                app.template = document.getElementById("messageTemplate").innerHTML;

                // create a signalr connection (ready to connect, but not yet connected)
                app.connection = new signalR.HubConnectionBuilder()
                    .withUrl(`${apiBaseUrl}/api`)
                    .build();

                // setup a callback for signalr to send messages back to
                app.connection.on('newMessage', function (message) {
                    app.messageHandler(message);
                });

                // setup a callback to tell me when my connection is lost
                app.connection.onclose(function () { console.log('disconnected'); });

                // now initiate the connection
                app.connection.start()
                    .then(function () { app.ready = true; })
                    .catch(console.error);

                // make enter send the message unless empty
                document.onkeydown = function (e) {
                    if (window.event.keyCode == '13') {
                        var text = document.getElementById("messageText").value;
                        app.sendMessage(text);
                        e.stopPropagation();
                    }
                }
            },

            ///////////////////////////////////////////////
            // Send a message to signalR
            ///////////////////////////////////////////////
            sendMessage: function (messageText) {
                var sender = document.getElementById("userName");

                // payload is an arbitrary object (i.e. could be your whole state)
                var message = {
                    recipient: '',
                    sender: sender.value,
                    payload: {
                        priority: 100,
                        text: messageText
                    }
                };

                // don't allow changing user name once set
                if(sender.value) {
                    sender.disabled = true;
                }

                // blank out the messageText textbox
                document.getElementById("messageText").value = "";

                // send the message using axios promises
                return axios.post(`${apiBaseUrl}/api/send`, message)
                    .then(
                        function (resp) {
                            console.log(resp.data);
                        },
                        function (err) {
                            console.log(err);
                        }
                    );
            },

            ///////////////////////////////////////////////
            // Handle a message coming back from signalR
            ///////////////////////////////////////////////
            messageHandler: function (message) {
                if (!message.sender) message.sender = "anonymous";
                console.log(message);

                // construct the HTML message
                var msgHtml = app.template;
                msgHtml = msgHtml.replace(/{{ message.sender }}/, message.sender);
                msgHtml = msgHtml.replace(/{{ message.text }}/, JSON.stringify(message.payload));

                // now shove the message into the dom
                var newDiv = document.createElement("div");
                newDiv.innerHTML = msgHtml;
                app.container.appendChild(newDiv);
            }
        };

        app.init();
    </script>
</body>

</html>